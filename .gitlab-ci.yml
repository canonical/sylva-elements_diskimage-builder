---

workflow:
  rules:
    - when: always
variables:
  REPO_URL: "oci://$CI_REGISTRY_IMAGE"

stages:
  - test
  - build

include:
  - project: 'renovate-bot/renovate-runner'
    ref: v16.8.2
    file: '/templates/renovate-config-validator.gitlab-ci.yml'
    rules:
      - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
        changes:
          paths:
            - .gitlab-ci.yml
            - renovate.json
  - project: 'sylva-projects/sylva-elements/renovate'
    ref: 1.0.0
    file: '/templates/renovate-dry-run.gitlab-ci.yml'
    rules:
      - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
        changes:
          paths:
            - renovate.json
  - project: "to-be-continuous/gitleaks"
    ref: 2.2.2
    file: "templates/gitlab-ci-gitleaks.yml"

.build-image:
  stage: build
  tags:
    - oro-libvirt
  before_script:
    - curl -O http://ports.ubuntu.com/pool/main/d/debootstrap/debootstrap_1.0.126+nmu1_all.deb
    - sudo dpkg -i debootstrap_1.0.126+nmu1_all.deb
    - sudo apt install zstd -y
  script:
    - export PATH="${HOME}/.local/bin:${PATH}"
    - pip3 install diskimage-builder --break-system-packages
    - python3 -m pip install --user . --break-system-packages
    - kanod-image-builder -s target=$TARGET_OS -s release=$TARGET_RELEASE  -o $DISK_IMAGE_NAME.qcow2
    - sha256sum $DISK_IMAGE_NAME.qcow2 | awk '{ print $1 }'
    - flux push artifact $REPO_URL/$DISK_IMAGE_NAME:$(git tag --points-at HEAD) --timeout 2h --path="$DISK_IMAGE_NAME.qcow2" --source="${CI_REPOSITORY_URL/gitlab-ci-token*@/}" --revision="$(git tag --points-at HEAD)@sha1:$(git rev-parse HEAD)" --creds $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD
  variables:
    TARGET_OS=ubuntu
    TARGET_RELEASE=jammy
  only:
    - tags

build-hardened:
  extends: .build-image
  variables:
    DISK_IMAGE_NAME: diskimage-builder-hardened
    KANOD_OPTIONS: "-b no_kanod_network -b cis_remediation -b lvm -b rke2_airgapped"

build-plain:
  extends: .build-image
  variables:
    DISK_IMAGE_NAME: diskimage-builder-plain
    KANOD_OPTIONS: "-b no_kanod_network -b rke2_airgapped"
