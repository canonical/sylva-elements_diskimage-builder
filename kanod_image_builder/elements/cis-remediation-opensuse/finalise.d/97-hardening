#!/bin/bash
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"

# Generate tailoring file to remove not compatible rules
autotailor -v var_sshd_set_keepalive=${HARDENING_SSHD_CLIENTALIVECOUNTMAX} -v sshd_idle_timeout_value=${HARDENING_SSHD_CLIENTALIVEINTERVAL} -v var_sshd_set_login_grace_time=${HARDENING_SSHD_LOGINGRACETIME} -v sshd_max_auth_tries_value=${HARDENING_SSHD_MAXAUTHTRIES} -v var_sshd_max_sessions=${HARDENING_SSHD_MAXSESSIONS} -v var_sshd_set_maxstartups=${HARDENING_SSHD_MAXSTARTUPS} -v sshd_approved_ciphers=${HARDENING_SSHD_CIPHERS} -v sshd_approved_macs=${HARDENING_SSHD_MACS} -v sshd_strong_macs=${HARDENING_SSHD_MACS} -v sshd_strong_kex=${HARDENING_SSHD_KEXALGORITHMS} -v sysctl_net_ipv6_conf_all_forwarding_value=1 -v sysctl_net_ipv4_conf_all_forwarding_value=1 -v sysctl_net_ipv4_conf_all_rp_filter_value=2 -v sysctl_net_ipv4_conf_default_rp_filter_value=2 --unselect package_firewalld_installed --unselect service_firewalld_enabled --unselect package_dhcp_client_removed --unselect banner_etc_issue --unselect banner_etc_issue_net --unselect kernel_module_vfat_disabled --output tailoring_file.xml --new-profile-id xccdf_org.ssgproject.content_profile_cis_custom /usr/share/xml/scap/ssg/content/ssg-sle15-ds-1.2.xml xccdf_org.ssgproject.content_profile_cis

# Reformat tailoring XML file (bug on OpenSCAP version < 1.39)
xmllint --format tailoring_file.xml > tailoring_file_correct.xml

# Generate the bash script with all the rules to apply including the customization from the tailoring file
oscap xccdf generate fix --profile xccdf_org.ssgproject.content_profile_cis_custom --tailoring-file tailoring_file_correct.xml  --output fix.sh /usr/share/xml/scap/ssg/content/ssg-sle15-ds-1.2.xml

# Execute the bash scripts
chmod +x fix.sh
./fix.sh || true

# Cleanup
zypper -n remove openscap-utils openscap scap-security-guide libopenscap25 libxml2-tools
rm -rf tailoring_file.xml tailoring_file_correct.xml fix.sh

