#!/bin/bash

#  Copyright (C) 2020-2021 Orange
#
#    Licensed under the Apache License, Version 2.0 (the "License"); you may
#    not use this file except in compliance with the License. You may obtain
#    a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#    License for the specific language governing permissions and limitations
#    under the License.


if [ -z "$1" ]; then
    exit 0
fi
if [ ! -f "/var/lib/grub-init" ]; then
    touch "/var/lib/grub-init"
    if type grub2-mkconfig >/dev/null; then
        GRUB_MKCONFIG="grub2-mkconfig"
    else
        GRUB_MKCONFIG="grub-mkconfig"
    fi
    current_grub=$(grep '^GRUB_CMDLINE_LINUX_DEFAULT=' /etc/default/grub | tail -1 | sed -e "s/^[^=]*=[\"']\\?//" -e "s/['\"]$//")
    next_grub="$current_grub $1"
    # No need for a timeout. Nobody attends
    sed -i -e '/GRUB_TIMEOUT=5/ d' /etc/default/grub
    # Delete the old command-line
    sed -i -e '/^GRUB_CMDLINE_LINUX_DEFAULT=/ d' /etc/default/grub
    # No wait on reboot (first considered as failed)
    echo "GRUB_RECORDFAIL_TIMEOUT=1" >> /etc/default/grub
    echo "GRUB_CMDLINE_LINUX_DEFAULT=\"${next_grub}\"" >> /etc/default/grub
    if command -v update-grub > /dev/null
    then
        # Debian way - so simple
        update-grub
    else
        # Update an EFI configuration if it exists
        if [ -f '/boot/efi/EFI/centos/grub.cfg' ]; then
            $GRUB_MKCONFIG -o /boot/efi/EFI/centos/grub.cfg
        fi
        # Update a legacy bios configuration if it exists
        if [ -f '/boot/grub2/grub.cfg' ]; then
            $GRUB_MKCONFIG -o /boot/grub2/grub.cfg
        fi
    fi
    # Reboot with cloud-init running again
    cloud-init clean --reboot
fi
# If next same as current, do nothing. We have reached our fixpoint.
